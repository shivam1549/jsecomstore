<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        .filtervals {
            cursor: pointer;
        }

        .galleryimg img {
            /* width: 4rem; */
            height: 4rem;
            object-fit: contain;

        }

        .galleryimg {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            /* flex-wrap: wrap; */
        }
    </style>

</head>

<body>

    <div class="container p-5">
        <div class="row">
            <div class="col-md-4">
                <div id="imgslider">

                </div>
            </div>
            <div class="col-md-8">
                <div class="productinner">

                </div>
            </div>
        </div>
    </div>



<script>


    // showProduct();

    async function fetchDataById() {

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const id = urlParams.get('id');

        try {
            const response = await fetch(`get-single-product.php?data=${id}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log(data);
            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
        }

        // console.log(id)

    }
    showProductdetails();
    async function showProductdetails() {

        try {
            const productDatas = await fetchDataById();
            const productData = productDatas.data;
            if (productData) {
                var producthtml = '';
                var productDescription = '';
                // alert(productIndex); 
                producthtml += `
     <div class="swipercontainerwrap">
            <img class="w-100 swipesimg" id="mainimg" src="${productData.image}"><div id="galleryimg" class="galleryimg">`;
                // console.log(productData.gallery + "gallimages")
                if (productData.gallery) {
                    const galleryArray = JSON.parse(productData.gallery);
                    galleryArray.forEach(img => {
                        producthtml += ` <img class="swipesimg" src="${img}">`;
                    })
                }
                producthtml += `</div></div>`;
                productDescription += `
     <h2>${productData.title}</h2>

     <h5 class="text-success bold mt-2 mb-2" id="price"></h5>

     <div>${productData.description}</div>
     <div><button type="button" disabled="true" data-productid="${productData.id}" class="btn btn-info add-to-cart">Add to cart +</button></div>
     <div id="cartbutton"></div>


     `;
                //  console.log(productData.long_description)
                // console.log(productData.attributes + "Argrrpro")
                var attributesSingleproduct = JSON.parse(productData.attributes);
                Object.entries(attributesSingleproduct).map(([key, values]) => {
                    productDescription += "<div>";
                    if (key === "color" || key === "Color") {
                        productDescription += `<strong class="mb-2">${key[0].toUpperCase() + key.slice(1)}</strong><br>`;
                        productDescription += `<div class="d-flex" style="gap:2px">`
                        // console.log(typeof(key))
                        var i = 1;
                        values.forEach(element => {
                            // console.log(element)

                            productDescription += `<span class="filtervals" title="${element}" style="background-color: ${element}; width:10px; height:10px; display: inline-flex; border:1px solid #000;"><input type="radio" name="${key}" class="selectfilter"  value="${element}"></span><br>`
                            i++;
                        });

                        productDescription += `</div>`
                    }
                    else {

                        productDescription += ` <strong class="mb-2">${key[0].toUpperCase() + key.slice(1)}</strong><br>`
                        var i = 1;
                        values.forEach(element => {
                            // console.log(element)

                            productDescription += `<span class="filtervals" style="border:1px solid #cacaca; width:15px; height:15px; text-align:center; margin: 0 10px;" title="${element}">${element} <input type="radio" name="${key}" class="selectfilter"  value="${element}"></span>`
                            i++;
                        });
                    }


                    productDescription += "</div>";
                })

                document.querySelector(".productinner").innerHTML = productDescription;

                document.querySelector("#imgslider").innerHTML = producthtml;



                var objattributeLenght = Object.keys(attributesSingleproduct).length;
                // showSlides();
                var filtersattribute = {}
                var selectedFilters = document.querySelectorAll(".selectfilter");
                // console.log(selectedFilters.length + " lenght")
                selectedFilters.forEach(function (filter) {
                    filter.addEventListener("change", function () {
                        // console.log("hi")
                        if (!filtersattribute[this.name]) {
                            filtersattribute[this.name] = [];
                        }
                        if (this.checked) {
                            if (filtersattribute[this.name].length > 0) {
                                filtersattribute[this.name].splice(0, 1);
                            }
                            filtersattribute[this.name].push(this.value);
                        }


                        console.log(filtersattribute)

                        var objfiltersattributeenght = Object.keys(filtersattribute).length;
                        var variationSingleproduct = JSON.parse(productData.variations);
                        variationSingleproduct.forEach(elem => {
                            let allMatch = true;
                            for (let key in filtersattribute) {
                                if (!filtersattribute[key].includes(elem[key])) {
                                    allMatch = false;
                                    break;
                                }
                            }
                            if (allMatch) {
                                if (objfiltersattributeenght === objattributeLenght) {
                                    JSON.stringify(elem);
                                    var pricemain = elem.price;
                                    // alert(pricemain);
                                    document.querySelector("#price").innerHTML = "$" + elem.price;
                                    document.querySelector(".add-to-cart").removeAttribute("disabled");
                                    document.querySelector(".add-to-cart").setAttribute("price", elem.price);
                                    document.querySelector(".add-to-cart").setAttribute("img", elem.img);
                                    document.querySelector("#mainimg").src = elem.img;
                                    // console.log(elem.gallery.length + " variations my")
                                    if (elem.gallery.length > 0) {
                                        var galleryimgvariations = "";
                                        console.log(elem.galleryimg)
                                        elem.gallery.forEach(image => {
                                            galleryimgvariations += ` <img class="swipesimg" src="${image}">`;
                                        })
                                        document.querySelector("#galleryimg").innerHTML = galleryimgvariations;
                                    }
                                    else {
                                        document.querySelector("#galleryimg").innerHTML = "";
                                    }
                                }
                                // console.log(`Matching Variation: ${JSON.stringify(elem)}`);
                                // console.log(`Price: ${elem.price}`);
                            }

                        })
                        var swiperimgages = document.querySelectorAll(".swipesimg");
                        swiperImg(swiperimgages)



                    })
                })


                var swiperimgages = document.querySelectorAll(".swipesimg");
                swiperImg(swiperimgages)

                var addTocart = document.querySelector(".add-to-cart");
                addTocart.addEventListener("click", function (e) {
                    // alert("add to ")
                    var selectedattributes = document.querySelectorAll(".selectfilter:checked");
                    // console.log(selectedattributes)
                    var selectedfitervals = {};
                    var selectvalues = Array.from(selectedattributes).map(function (radio) {
                        if (!selectedfitervals[radio.name]) {
                            selectedfitervals[radio.name] = new Set();
                        }
                        if (radio.checked) {
                            selectedfitervals[radio.name].add(radio.value);
                        }
                        return selectedfitervals;
                    })
                    Object.keys(selectedfitervals).forEach(function (key) {
                        selectedfitervals[key] = Array.from(selectedfitervals[key]);
                    });

                    console.log(selectedfitervals);
                    console.log(selectvalues + "hdh")
                    console.log(e.target.getAttribute("data-productid"))

                    var formData = new FormData();
                    formData.append("filters", JSON.stringify(selectedfitervals));
                    formData.append("productid", e.target.getAttribute("data-productid"));
                    formData.append("price", e.target.getAttribute("price"));
                    formData.append("img", e.target.getAttribute("img"));
                    if (selectvalues) {
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "add-to-cart.php", true);

                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === XMLHttpRequest.DONE) {
                                if (xhr.status === 200) {
                                   var response = JSON.parse(xhr.response);
                                   if(response.success){
                                        document.querySelector("#cartbutton").innerHTML = "<a href='cart.php'>Go to cart</a>"
                                   }
                                }
                            }
                        };

                        xhr.send(formData);
                    }

                    // console.log(selectvalues + "gg");

                })
            }
            else {
                console.error('No product data found.');
            }
        } catch (error) {
            console.error('Error:', error);
        }

    }


    function swiperImg(swiperimg) {
        swiperimg.forEach(swiper => {
            swiper.addEventListener("click", function () {
                // Display an alert when an image is clicked
                // alert("he");

                // Set the src of the main image to the src of the clicked image
                document.querySelector("#mainimg").src = this.src;
            });
        });
    }

    function showSlides() {
        // console.log("first")
        const slideshowContainer = document.querySelector('.swipercontainerwrap');
        const slides = slideshowContainer.querySelectorAll('.swipesimg');
        let currentSlideIndex = 0;

        slides.forEach(slide => {
            slide.style.display = 'none';
        });

        slides[currentSlideIndex].style.display = 'block';

        setInterval(() => {
            slides[currentSlideIndex].style.display = 'none';
            currentSlideIndex = (currentSlideIndex + 1) % slides.length;
            slides[currentSlideIndex].style.display = 'block';
        }, 2000); // 2 seconds interval
    }
</script>
</body>
</html>